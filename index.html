<!DOCTYPE html>
<html ng-app="WeasleyClock">
<head>
	<title>Weasley Clock App</title>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.0/angular.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.0/angular-route.min.js"></script>

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>

	<!-- Firebase -->
	<script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
	
	<!-- AngularFire -->
	<script src="https://cdn.firebase.com/libs/angularfire/1.1.3/angularfire.min.js"></script>

	<script type="text/javascript" src="app.js"></script>
	<script type="text/javascript" src="homeCtrl.js"></script>

	<link rel="stylesheet" type="text/css" href="style.css">

	<!--Bootstrap-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

	<!-- Firebase -->
	<script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>

	<!-- ArcGIS -->
	<link rel="stylesheet" href="https://js.arcgis.com/3.15/esri/css/esri.css">
	<script src="https://js.arcgis.com/3.15/"></script>

	<script type="text/javascript">
		var map;
		var currLocation;
		require([
			"esri/map",
			"esri/geometry/Point",
		    "dojo/ready", 
		    "esri/Color",
		    "dojo/_base/array",
		    "esri/arcgis/utils",
		    "esri/config",
		    "esri/graphicsUtils",
		    "esri/symbols/SimpleFillSymbol",
		    "esri/graphic", 
		    "esri/geometry/geometryEngine",
		    "dojo/domReady!"
		],
		function(
			Map,
			Point,
			ready, 
		    Color,
		    array,
		    arcgisUtils,
		    config,
		    graphicsUtils,
		    SimpleFillSymbol,
		    Graphic,
		    geometryEngine
			) {
			map = new Map("mapDiv", {
				center: [-56.049, 38.485],
				zoom: 3,
				basemap: "streets"
			});
			map.on("load", initFunc);

			// var geometries = []

			function initFunc(map) {
				if(navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(zoomToLocation, locationError);
				} else {
					console.log('you fucked up');
				}
			}

			function locationError(error) {
				console.log(error);
			}

			function zoomToLocation(location) {
				var pt = new Point(location.coords.longitude, location.coords.latitude);
				var newlocation = 'unknown';
				console.log(pt);
				console.log(pt.spatialReference);
				map.centerAndZoom(pt, 12);
				// console.log('now attempting to get the buffer region thing');
				// geodesicBuffer(geometry, distance, unit, unionResults?)


				// var featureLayer = map.getLayer(map.graphicsLayerIds[0]);
				// debugger
		  		// var geometries = graphicsUtils.getGeometries(featureLayer.graphics);
		  		// debugger;

		  		// top left to bottom right
		  		var locations = [	// {x: x-val, y: y-val}
		  			{
		  				topx: -81,
		  				topy: 44.2929973,
		  				bottomx: -84.7149281,
		  				bottomy: 41.2927428,
		  				type: 'Work',
		  				loc: 'Chem Eng'
		  			},
		  			{
		  				topx: -83.7149281,
		  				topy: 42.2927428,
		  				bottomx: -83.7144473,
		  				bottomy: 42.3081689,
		  				type: 'Work',
		  				loc: 'Library'
		  			}
		  		];

		  		angular.forEach(locations, function (place) {
		  			if(	parseFloat(place.topx) >= parseFloat(pt.x) && parseFloat(pt.x) >= parseFloat(place.bottomx) &&
		  				parseFloat(place.topy) >= parseFloat(pt.y) && parseFloat(pt.y) >= parseFloat(place.bottomy) ) {
		  				console.log('in ' + place.loc);
		  				newlocation = place.type;
		  			} else {
		  				console.log('nope');
		  			}
		  		})

		  		// send place.type to the firebase server to update
		  		var myFirebaseRef = new Firebase("https://fiery-heat-1300.firebaseio.com/people/1");

		  		// myFirebaseRef.set({
		  		// 	id: 1,
		  		// 	name: 'John',
		  		// 	location: 'Work',
		  		// 	image: 'https://pbs.twimg.com/profile_images/1501070030/John_2011_1_500x500.png'
		  		// });

		  		myFirebaseRef.update({
		  			location: newlocation
		  		});


		  		// var userRef = myFirebaseRef.child("1");
		  		// // var updateRef = userRef.child('1');
		  		// userRef.update({
		  		// 	'nickname': 'Hello'
		  		// });

				
			}

		});
	</script>

</head>
<body>

	<div class="clock">
		<a href="#/">Home</a>
		<div ng-view></div>
		<div id='peopleDiv'></div>
	</div>

	<input type='text' id='nameInput' placeholder='Name'>
    <input type='text' id='locationInput' placeholder='Location'>
    <input type='text' id='imageInput' placeholder='Image'>

    <script>
      var myDataRef = new Firebase('https://fiery-heat-1300.firebaseio.com/');
      $('#imageInput').keypress(function (e) {
        if (e.keyCode == 13) {
          var name = $('#nameInput').val();
          var location = $('#locationInput').val(); 
          var image = $('#imageInput').val();
          myDataRef.push({name: name, location: location, image: image});
          $('#nameInput').val('');
          $('#locationInput').val('');
          $('#imageInput').val('');
        }
      });
      myDataRef.on('child_added', function(snapshot) {
        var person = snapshot.val();
        displayPeople(person.name, person.location, person.image);
      });
      function displayPeople(name, location, image) {
        $('<div/>').text(location).text(image).prepend($('<em/>').text(name+': ')).appendTo($('#peopleDiv'));
        $('#peopleDiv')[0].scrollTop = $('#peopleDiv')[0].scrollHeight;
      };
    </script>

</body>
</html>